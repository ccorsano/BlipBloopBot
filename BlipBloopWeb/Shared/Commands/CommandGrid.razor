@using System.Linq
@using BotServiceGrain
@using Conceptoire.Twitch.Commands
@using Conceptoire.Twitch.Options
@using Microsoft.Extensions.DependencyInjection
@inject IClientProvider ClientProvider
@inject IDialogService DialogService

<MudTable Items="@Commands" @bind-SelectedItem="SelectedItem" Context="command" OnCommitEditClick="@(c => OnConfirmCommand(c))">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Commands</MudText>
        <MudToolBarSpacer />
        <MudIconButton Icon="@Icons.Filled.AddCircle" OnClick="OnAdd" />
    </ToolBarContent>
    <HeaderContent>
        <MudTh>Trigger</MudTh>
        <MudTh>Command type</MudTh>
        <MudTh>Parameters</MudTh>
        <MudTh></MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Trigger">@command.Name</MudTd>
        <MudTd DataLabel="Type">@command.Type</MudTd>
        <MudTd DataLabel="Parameters">
            <MudList>
                @foreach (var keyvaluePair in command.Parameters)
                {
                    <MudListItem>
                        <MudText Typo="Typo.body2">@keyvaluePair.Key :  @keyvaluePair.Value</MudText>
                    </MudListItem>
                }
            </MudList>
        </MudTd>
        <MudTd></MudTd>
    </RowTemplate>
    <RowEditingTemplate>
        <MudTd DataLabel="Trigger">
            <MudTextField @bind-Value="@command.Name" />
        </MudTd>
        <MudTd DataLabel="Type">
            <MudSelect @bind-Value="@command.Type" T="string" Label="Bot command type selection">
                @foreach (var commandType in ServiceContext.AvailableCommands)
                {
                    <MudSelectItem Value="@commandType.Name">@commandType.Name</MudSelectItem>
                }
            </MudSelect>
        </MudTd>
        <MudTd DataLabel="Parameters">
            <MudButton OnClick="(_) => EditParameters(command)" Variant="Variant.Filled" Color="Color.Primary">Edit parameters</MudButton>
        </MudTd>
        <MudTd Class="pa-0">
            <MudTooltip Text="Delete">
                <MudIconButton Class="pa-0" Icon="@Icons.Filled.Delete" OnClick="(_) => Delete(command)" />
            </MudTooltip>
        </MudTd>
    </RowEditingTemplate>
</MudTable>

@code {
    [CascadingParameter(Name = "ServiceContext")]
    public MainLayout ServiceContext { get; set; }

    public List<CommandItemModel> Commands { get; set; }
    private CommandItemModel NewItem { get; set; }
    private CommandItemModel SelectedItem { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        var client = await ClientProvider.GetConnectedClient();
        var channelGrain = client.GetGrain<IChannelGrain>(ServiceContext.UserId);

        Commands = (await channelGrain.GetBotCommands()).Select(ToCommandItem).ToList();

        await base.OnParametersSetAsync();
    }

    protected async Task EditParameters(CommandItemModel command)
    {
        var dialogParameters = new DialogParameters();
        dialogParameters.Add("Parameters", command.Parameters);
        var result = await DialogService.Show<ParametersEditDialog>("Parameters", dialogParameters).Result;

        if (result.Cancelled)
        {
            return;
        }

        command.Parameters = ((Dictionary<string, string>) result.Data);
    }

    protected void OnAdd()
    {
        Commands.Add(new CommandItemModel
        {
            Aliases = new List<string>(),
            Parameters = new Dictionary<string, string>(),
        });
        SelectedItem = Commands.Last();
    }

    protected async Task Delete(CommandItemModel command)
    {
        if (command.Id.HasValue)
        {
            var client = await ClientProvider.GetConnectedClient();
            var channelGrain = client.GetGrain<IChannelGrain>(ServiceContext.UserId);
            await channelGrain.DeleteCommand(command.Id.Value);
        }
        Commands.Remove(command);
    }

    protected async Task OnDelete(MouseEventArgs evt)
    {
        var client = await ClientProvider.GetConnectedClient();
        var channelGrain = client.GetGrain<IChannelGrain>(ServiceContext.UserId);

        Commands = (await channelGrain.GetBotCommands()).Select(ToCommandItem).ToList();
    }

    protected async Task OnValidate(MouseEventArgs evt)
    {
        var client = await ClientProvider.GetConnectedClient();
        var channelGrain = client.GetGrain<IChannelGrain>(ServiceContext.UserId);

        Commands = (await channelGrain.GetBotCommands()).Select(ToCommandItem).ToList();
    }

    protected CommandItemModel ToCommandItem(CommandOptions options) => new CommandItemModel
    {
        Id = options.Id,
        Name = options.Name,
        Aliases = options.Aliases?.ToList() ?? new List<string>(),
        Type = options.Type,
        Parameters = options.Parameters.ToDictionary(kvp => kvp.Key, kvp => kvp.Value),
    };

    protected async Task OnConfirmCommand(MouseEventArgs evt)
    {
        if (string.IsNullOrEmpty(SelectedItem.Type))
        {
            return;
        }

        var client = await ClientProvider.GetConnectedClient();
        var channelGrain = client.GetGrain<IChannelGrain>(ServiceContext.UserId);

        if (!SelectedItem.Id.HasValue)
        {
            var commandStub = new CommandOptions { Name = SelectedItem.Name, Aliases = new string[] { SelectedItem.Name }, Type = SelectedItem.Type, Parameters = SelectedItem.Parameters };
            await channelGrain.AddCommand(commandStub);
        }
        else
        {
            var commandStub = new CommandOptions { Id = SelectedItem.Id.Value, Name = SelectedItem.Name, Aliases = new string[] { SelectedItem.Name }, Type = SelectedItem.Type, Parameters = SelectedItem.Parameters };
            await channelGrain.DeleteCommand(SelectedItem.Id.Value);
            await channelGrain.AddCommand(commandStub);
        }
    }
}
