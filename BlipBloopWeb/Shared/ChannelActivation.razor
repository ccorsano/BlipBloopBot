@using BlipBloopWeb
@using BotServiceGrain
@inject IClientProvider ClientProvider

<MudCard>
    <MudCardHeader>
        <MudText>Channel Activation</MudText>
    </MudCardHeader>
    <MudCardContent>
        @if (_isLoading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
        }
        else if (ServiceContext.IsChannelIntegrationActive)
        {
            <MudText Typo="Typo.h5">
                <MudIcon Icon="@Icons.Outlined.CheckBox" Color="Color.Success"></MudIcon>
                Channel integration is active.
            </MudText>
            <ChannelStaffList ChannelId="@ServiceContext.UserId" />
        }
        else
        {
            <MudText Typo="Typo.h5">
                <MudIcon Icon="@Icons.Outlined.CheckBoxOutlineBlank" Color="Color.Dark"></MudIcon>
                Channel integration is inactive.
            </MudText>
            <MudLink @onclick="ActivateChannelAsync">Activate channel integration</MudLink>
        }
    </MudCardContent>
</MudCard>

@code {
    [CascadingParameter(Name = "ServiceContext")]
    public MainLayout ServiceContext { get; set; }

    private bool _isLoading = true;
    private IUserGrain _userGrain;

    protected override Task OnInitializedAsync()
    {

        return base.OnInitializedAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        var client = await ClientProvider.GetConnectedClient();

        _userGrain = client.GetGrain<IUserGrain>(ServiceContext.UserId);
        await _userGrain.SetOAuthToken(ServiceContext.OAuthToken);
        ServiceContext.SetChannelIntegrationActive(await _userGrain.HasActiveChannel());

        _isLoading = false;

        await base.OnParametersSetAsync();
    }

    protected async Task ActivateChannelAsync()
    {
        await _userGrain.ActivateChannel();
        ServiceContext.SetChannelIntegrationActive(await _userGrain.HasActiveChannel());
    }
}
